<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts Diary</title>
    
    <!-- FAVICON FIX - Multiple formats -->
    <link rel="shortcut icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAYklEQVR4nGNgGAWjYBSMglEwCkbBYAOMICws4C8jIygpCiEG+Pv7Kz9//pzxxYsX/2ESjDDJy5cv/wMxQ5CaEQYwgPhAzIiLi8OoYQQqAglgo8Da2hqiBiiAG4DUjAIMDAAAz1sK++C8KfUAAAAASUVORK5CYII=" />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%93%92%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%93%92%3C/text%3E%3C/svg%3E">
    
    <!-- DEBUG META TAGS -->
    <meta name="debug-info" content="Accounts-Diary-App-v1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- DEBUG SCRIPT TO CHECK RESOURCES -->
    <script>
        // DEBUG: Resource loading checker
        function checkResources() {
            console.log('=== DEBUG: Resource Check Started ===');
            console.log('Document loaded at:', new Date().toISOString());
            console.log('Current URL:', window.location.href);
            console.log('Document title:', document.title);
            
            // Check if style.css loads
            const styleTest = document.createElement('link');
            styleTest.rel = 'stylesheet';
            styleTest.href = 'style.css';
            styleTest.onload = () => console.log('‚úÖ style.css loaded successfully');
            styleTest.onerror = () => console.error('‚ùå style.css failed to load');
            document.head.appendChild(styleTest);
            
            // Check if favicon is set
            const favicon = document.querySelector('link[rel*="icon"]');
            if (favicon) {
                console.log('‚úÖ Favicon found:', favicon.href.substring(0, 50) + '...');
            } else {
                console.error('‚ùå No favicon found!');
            }
            
            // Check for essential scripts
            const requiredScripts = ['db.js', 'app.js'];
            requiredScripts.forEach(script => {
                console.log(`‚è≥ Checking for ${script}...`);
            });
            
            console.log('=== DEBUG: Resource Check Complete ===');
        }
        
        // Run check when DOM is ready
        document.addEventListener('DOMContentLoaded', checkResources);
        
        // Additional check after page fully loads
        window.addEventListener('load', () => {
            console.log('=== DEBUG: Window Load Complete ===');
            console.log('All resources loaded at:', new Date().toISOString());
            console.log('Current user agent:', navigator.userAgent);
            
            // Check if we're on Vercel
            if (window.location.hostname.includes('vercel.app')) {
                console.log('üöÄ Running on Vercel deployment');
            }
            
            // Log any errors that occurred
            window.addEventListener('error', function(e) {
                console.error('‚ùå Global error caught:', e.message, 'at', e.filename, 'line', e.lineno);
            });
        });
    </script>
</head>
<body>
    <!-- DEBUG BANNER - Only shows in development -->
    <div id="debugBanner" style="position: fixed; top: 0; left: 0; right: 0; background: #ff6b6b; color: white; padding: 5px; text-align: center; font-size: 12px; z-index: 9999; display: none;">
        DEBUG MODE | Check console for resource status
    </div>
    
    <!-- ==================== AUTHENTICATION SCREEN ==================== -->
    <div id="authScreen" style="display: block;">
        <div class="auth-container">
            <h1>üí∞ Accounts Diary</h1>
            <div class="auth-box">
                <h3>üîê Login to Continue</h3>
                <div class="input-group">
                    <input type="email" id="authEmail" placeholder="Email">
                </div>
                <div class="input-group">
                    <input type="password" id="authPassword" placeholder="Password">
                </div>
                <div class="auth-buttons">
                    <button onclick="login()" class="primary-btn">Login</button>
                    <button onclick="register()" class="secondary-btn">Register</button>
                </div>
                <p id="authError" style="color: red; margin-top: 10px;"></p>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP SCREEN ==================== -->
    <div id="appScreen" style="display: none;">
        <!-- Navigation -->
        <nav>
            <button onclick="showPage('home')">üè† Home</button>
            <button onclick="showPage('entry')">‚ûï Add Entry</button>
            <button onclick="showPage('balance')">üí∞ Balance</button>
            <button onclick="showPage('ledger')">üìí Ledger</button>
            <button onclick="showPage('search')">üîç Search</button>
            <button onclick="showPage('settings')">‚öôÔ∏è Settings</button>
            <button onclick="logout()" class="danger-btn">üö™ Logout</button>
        </nav>

        <!-- HOME PAGE -->
        <section id="home" class="page">
            <h2>Welcome, <span id="userName">User</span>!</h2>
            <h3>Total Balance</h3>
            <h1 id="totalBalance">PKR 0.00</h1>
            
            <div class="status-box">
                <p id="syncStatus">üîÑ Sync Status: Checking...</p>
                <p id="entryCount">üìù Total Entries: 0</p>
                <p id="homeSyncStatus">üîÑ Sync with Cloud: Ready</p>
            </div>
            
            <div class="quick-actions">
                <button onclick="showPage('entry')" class="primary-btn">‚ûï Add New Entry</button>
                <button onclick="showPage('ledger')" class="secondary-btn">üìä View Ledger</button>
                <button onclick="quickSearch()" class="secondary-btn">üîç Quick Search</button>
            </div>
            
            <div class="recent-entries">
                <h3>üìã Recent Transactions (Last 10)</h3>
                <div id="recentEntries">
                    <div class="no-entries">No recent transactions</div>
                </div>
            </div>
        </section>

        <!-- SETTINGS PAGE -->
        <section id="settings" class="page">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="settings-section">
                <h3>1Ô∏è‚É£ Category Management</h3>
                <div class="input-group">
                    <input type="text" id="mainHeadInput" placeholder="Enter Main Category (e.g., Food, Salary)">
                    <button onclick="addMainHead()" class="primary-btn">‚ûï Add Main Category</button>
                </div>
                
                <div class="input-group">
                    <select id="mainForSub"></select>
                    <input type="text" id="subHeadInput" placeholder="Enter Sub Category (e.g., Groceries, Dining)">
                    <button onclick="addSubHead()" class="primary-btn">‚ûï Add Sub Category</button>
                </div>
                
                <div class="categories-list">
                    <h4>üìÅ Current Categories</h4>
                    <ul id="headList"></ul>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>2Ô∏è‚É£ User Information</h3>
                <div id="userInfo">
                    <div class="status-indicator status-connected">
                        <strong>Logged in as:</strong> <span id="settingsUserEmail">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>3Ô∏è‚É£ Cloud Sync Status</h3>
                <div id="cloudSyncStatus">
                    <div class="status-indicator status-disconnected">
                        ‚ùå Cloud Sync: Not configured
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="testAPI()" class="secondary-btn">üß™ Test API Connection</button>
                </div>
            </div>
            
            <!-- CSV Import/Export Section - ADDED DIRECTLY -->
            <div class="settings-section" id="csvSection">
                <h3>4Ô∏è‚É£ CSV Import/Export</h3>
                <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                    Export your data to CSV file or import entries from CSV file.
                </p>
                <div class="button-group" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button onclick="exportToCSV()" class="primary-btn" style="background-color: #4caf50;">
                        üì• Export All to CSV
                    </button>
                    <label style="cursor: pointer; display: inline-block;">
                        <div class="secondary-btn" style="background-color: #2196f3; padding: 12px 20px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; text-align: center;">
                            üì§ Import from CSV
                        </div>
                        <input type="file" id="csvImportInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                    </label>
                </div>
                <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <p style="margin: 0; color: #856404; font-size: 0.85em;">
                        <strong>Note:</strong> CSV import will add new entries. Existing entries with same ID will be updated.
                        Required columns: Date, Description, Main Category, Sub Category, Amount
                    </p>
                </div>
            </div>
        </section>

        <!-- ENTRY PAGE -->
        <section id="entry" class="page">
            <h2>‚ûï Add / Edit Entries</h2>
            
            <div class="entry-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Main Category:</label>
                        <select id="entryMain" onchange="updateEntrySubheads()">
                            <option value="">-- Select Main Category --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Sub Category:</label>
                        <select id="entrySub">
                            <option value="">-- Select Sub Category --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="date" value="">
                    </div>
                    
                    <div class="form-group">
                        <label>Description:</label>
                        <input type="text" id="desc" placeholder="Enter description">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount:</label>
                        <input type="number" id="amount" placeholder="Enter amount" step="0.01">
                        <small>Use positive for income, negative for expense</small>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="addTemp()" class="primary-btn">üìù Add to Temporary List</button>
                    <button onclick="saveAll()" class="success-btn">üíæ Save All Entries</button>
                    <button onclick="clearTemp()" class="secondary-btn">üóëÔ∏è Clear Temporary</button>
                    <button onclick="cancelEdit()" id="cancelEditBtn" class="secondary-btn" style="display: none;">‚ùå Cancel Edit</button>
                </div>
            </div>
            
            <div class="lists-container">
                <div class="list-section">
                    <h3>üìã Temporary Entries (Pending Save)</h3>
                    <div id="tempList">
                        <div class="no-entries">No temporary entries</div>
                    </div>
                </div>
                
                <div class="list-section">
                    <h3>üíæ Saved Entries (Recent 20)</h3>
                    <div id="savedEntryList">
                        <div class="no-entries">No saved entries</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BALANCE PAGE -->
        <section id="balance" class="page">
            <h2>üí∞ Balance Details</h2>
            
            <div class="summary-cards">
                <div class="card income-card">
                    <h4>Total Income</h4>
                    <p id="totalIncome">PKR 0.00</p>
                </div>
                <div class="card expense-card">
                    <h4>Total Expense</h4>
                    <p id="totalExpense">PKR 0.00</p>
                </div>
                <div class="card balance-card">
                    <h4>Net Balance</h4>
                    <p id="netBalance">PKR 0.00</p>
                </div>
            </div>
            
            <h3>üìä Category-wise Balance</h3>
            <ul id="balanceList" class="category-list"></ul>
        </section>

        <!-- LEDGER PAGE -->
        <section id="ledger" class="page">
            <h2>üìí Ledger View</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label>Main Category:</label>
                    <select id="ledgerMain" onchange="updateLedgerSubheads()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Sub Category:</label>
                    <select id="ledgerSub">
                        <option value="">All Sub-categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Date Range:</label>
                    <input type="date" id="fromDate">
                    <span>to</span>
                    <input type="date" id="toDate">
                </div>
                
                <div class="filter-group">
                    <label>Transaction Type:</label>
                    <select id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="income">Income Only</option>
                        <option value="expense">Expense Only</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Amount Range:</label>
                    <input type="number" id="minAmountFilter" placeholder="Min PKR" step="0.01">
                    <span>to</span>
                    <input type="number" id="maxAmountFilter" placeholder="Max PKR" step="0.01">
                </div>
            </div>
            
            <div class="action-buttons">
                <button onclick="loadLedger()" class="primary-btn">üîç Apply Filters</button>
                <button onclick="resetLedgerFilters()" class="secondary-btn">üîÑ Reset Filters</button>
                <button onclick="exportLedger()" class="success-btn">üì• Export to CSV</button>
            </div>
            
            <div class="ledger-summary">
                <p id="ledgerStats">Showing 0 transactions | Total: PKR 0.00</p>
            </div>
            
            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                <table id="ledgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Main Category</th>
                            <th>Sub Category</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerList">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px;">
                                No transactions found. Add entries from the "Add Entry" page.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- SEARCH PAGE -->
        <section id="search" class="page">
            <h2>üîç Search Transactions</h2>
            
            <div class="search-controls">
                <div class="search-input-group">
                    <input type="text" id="searchInput" placeholder="Search by description...">
                    <div class="search-buttons">
                        <button onclick="performSearch()" class="primary-btn">üîç Search</button>
                        <button onclick="clearSearch()" class="secondary-btn">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>Date Range:</label>
                            <div class="filter-item-row">
                                <input type="date" id="searchFromDate" placeholder="From">
                                <span>to</span>
                                <input type="date" id="searchToDate" placeholder="To">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label>Amount Range:</label>
                            <div class="filter-item-row">
                                <input type="number" id="minAmount" placeholder="Min PKR" step="0.01">
                                <span>to</span>
                                <input type="number" id="maxAmount" placeholder="Max PKR" step="0.01">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label>Type:</label>
                            <select id="searchType">
                                <option value="all">All Types</option>
                                <option value="income">Income Only</option>
                                <option value="expense">Expense Only</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label>Category:</label>
                            <select id="searchCategory">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="results-summary">
                <p id="searchResultsCount">üîç Found 0 transactions</p>
                <p id="searchTotal">üí∞ Total: PKR 0.00</p>
            </div>
            
            <div class="search-results">
                <div id="searchResults">
                    <div class="no-results">üì≠ No transactions found</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Load scripts -->
    <script src="db.js"></script>
    <script src="app.js"></script>
    
    <!-- EXTENSIVE DEBUG SCRIPT -->
    <script>
        // COMPREHENSIVE DEBUG SCRIPT
        console.log('üîß ========================================');
        console.log('üîß ACCOUNTS DIARY DEBUG MODE ACTIVATED');
        console.log('üîß ========================================');
        
        // Show debug banner
        const debugBanner = document.getElementById('debugBanner');
        if (window.location.hostname.includes('localhost') || window.location.hostname.includes('vercel')) {
            debugBanner.style.display = 'block';
        }
        
        // Resource verification
        function verifyResources() {
            console.log('üì¶ VERIFYING RESOURCES:');
            
            // Check critical files
            const resources = [
                { name: 'HTML Document', path: window.location.href, required: true },
                { name: 'CSS File', path: 'style.css', required: true },
                { name: 'Database JS', path: 'db.js', required: true },
                { name: 'App JS', path: 'app.js', required: true },
                { name: 'Manifest', path: 'manifest.json', required: false }
            ];
            
            resources.forEach(resource => {
                console.log(`   ${resource.required ? 'üî¥' : 'üü°'} ${resource.name}: ${resource.path}`);
            });
            
            // Check if favicon requests are happening
            console.log('   üü¢ Favicon: Using data URL (no file request)');
            
            // Browser compatibility
            console.log('üåê BROWSER INFO:');
            console.log('   User Agent:', navigator.userAgent);
            console.log('   Online:', navigator.onLine);
            console.log('   Platform:', navigator.platform);
            
            // Page structure check
            console.log('üèóÔ∏è PAGE STRUCTURE:');
            console.log('   Auth Screen:', document.getElementById('authScreen') ? '‚úÖ Found' : '‚ùå Missing');
            console.log('   App Screen:', document.getElementById('appScreen') ? '‚úÖ Found' : '‚ùå Missing');
            console.log('   Navigation:', document.querySelector('nav') ? '‚úÖ Found' : '‚ùå Missing');
            
            // Function availability
            console.log('‚öôÔ∏è FUNCTION CHECK:');
            console.log('   login():', typeof login === 'function' ? '‚úÖ Available' : '‚ùå Missing');
            console.log('   showPage():', typeof showPage === 'function' ? '‚úÖ Available' : '‚ùå Missing');
            console.log('   logout():', typeof logout === 'function' ? '‚úÖ Available' : '‚ùå Missing');
            
            // Storage check
            console.log('üíæ STORAGE CHECK:');
            console.log('   localStorage:', typeof localStorage !== 'undefined' ? '‚úÖ Available' : '‚ùå Unavailable');
            console.log('   sessionStorage:', typeof sessionStorage !== 'undefined' ? '‚úÖ Available' : '‚ùå Unavailable');
            
            // Check for 404 requests
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                if (url.includes('favicon.ico') || url.includes('404')) {
                    console.warn('‚ö†Ô∏è 404 Request detected:', url);
                    console.warn('   This is normal for favicon.ico if using data URL');
                }
                return originalFetch.apply(this, args);
            };
            
            // Check image requests
            const images = document.getElementsByTagName('img');
            console.log(`   Images on page: ${images.length}`);
            
            // Performance check
            if (window.performance && window.performance.timing) {
                const perf = window.performance.timing;
                const loadTime = perf.loadEventEnd - perf.navigationStart;
                console.log('‚è±Ô∏è PERFORMANCE:');
                console.log(`   Page load time: ${loadTime}ms`);
            }
        }
        
        // Initialize auth check with debug
        window.onload = function() {
            console.log('üöÄ Window.onload triggered');
            verifyResources();
            
            // Check auth after a slight delay
            setTimeout(() => {
                if (typeof checkAuth === 'function') {
                    console.log('üîê Calling checkAuth()...');
                    checkAuth();
                } else {
                    console.error('‚ùå checkAuth() function not found!');
                    console.log('‚ö†Ô∏è Using fallback authentication...');
                    
                    // Fallback auth logic
                    const authScreen = document.getElementById('authScreen');
                    const appScreen = document.getElementById('appScreen');
                    
                    if (authScreen && appScreen) {
                        // Check if user is already "logged in" (for demo)
                        const demoLoggedIn = localStorage.getItem('demoLoggedIn');
                        if (demoLoggedIn === 'true') {
                            authScreen.style.display = 'none';
                            appScreen.style.display = 'block';
                            console.log('‚úÖ Demo user logged in (fallback)');
                        }
                    }
                }
            }, 500);
        };
        
        // Error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('üî• GLOBAL ERROR:', msg);
            console.error('   URL:', url);
            console.error('   Line:', lineNo);
            console.error('   Column:', columnNo);
            console.error('   Stack:', error ? error.stack : 'No stack trace');
            return false;
        };
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('üî• UNHANDLED PROMISE REJECTION:', event.reason);
        });
        
        console.log('üîß DEBUG MODE READY - Opening console for details');
    </script>
</body>
</html>
