<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts Diary</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <style>
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e1e1e;
            color: #f0f0f0;
            border-top: 2px solid #007acc;
            z-index: 9999;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow: hidden;
        }
        
        .debug-header {
            background: #007acc;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .debug-title {
            font-weight: bold;
        }
        
        .debug-controls button {
            background: #005a9e;
            color: white;
            border: none;
            padding: 4px 8px;
            margin-left: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .debug-controls button:hover {
            background: #004578;
        }
        
        .debug-content {
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .debug-log {
            padding: 3px 0;
            border-bottom: 1px solid #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .debug-log.info { color: #c0c0c0; }
        .debug-log.success { color: #4caf50; }
        .debug-log.warning { color: #ff9800; }
        .debug-log.error { color: #f44336; }
        
        .debug-minimized {
            height: 35px;
        }
        
        .debug-minimized .debug-content {
            display: none;
        }
        
        .auth-debug {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .auth-debug h4 {
            margin-top: 0;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }
        
        .test-credentials {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- ==================== AUTHENTICATION SCREEN ==================== -->
    <div id="authScreen">
        <div class="auth-container">
            <h1>üí∞ Accounts Diary</h1>
            <div class="auth-box">
                <h3>üîê Login to Continue</h3>
                
                <div class="test-credentials">
                    <strong>Test Credentials:</strong><br>
                    Email: test@example.com<br>
                    Password: password123
                </div>
                
                <div class="input-group">
                    <input type="email" id="authEmail" placeholder="Email" value="test@example.com">
                </div>
                <div class="input-group">
                    <input type="password" id="authPassword" placeholder="Password" value="password123">
                </div>
                <div class="auth-buttons">
                    <button id="loginBtn" class="primary-btn">Login</button>
                    <button id="registerBtn" class="secondary-btn">Register</button>
                    <button id="testBtn" class="secondary-btn" style="background: #9c27b0;">üß™ Test API</button>
                </div>
                <div id="authError" style="color: red; margin-top: 10px; min-height: 20px;"></div>
                <div id="authStatus" style="color: green; margin-top: 10px; min-height: 20px;"></div>
                
                <!-- Debug Panel in Auth Screen -->
                <div class="auth-debug">
                    <h4>üõ†Ô∏è Debug Information</h4>
                    <div id="authDebugInfo" style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div>Waiting for user action...</div>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="testAPIConnection()" class="small-btn">Test API Connection</button>
                        <button onclick="checkLocalStorage()" class="small-btn">Check LocalStorage</button>
                        <button onclick="clearAuthDebug()" class="small-btn">Clear Logs</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP SCREEN ==================== -->
    <div id="appScreen" style="display: none;">
        <nav>
            <button onclick="showPage('home')">üè† Home</button>
            <button onclick="showPage('entry')">‚ûï Add Entry</button>
            <button onclick="showPage('balance')">üí∞ Balance</button>
            <button onclick="showPage('ledger')">üìí Ledger</button>
            <button onclick="showPage('search')">üîç Search</button>
            <button onclick="showPage('settings')">‚öôÔ∏è Settings</button>
            <button onclick="logout()" class="danger-btn">üö™ Logout</button>
        </nav>

        <!-- HOME PAGE -->
        <section id="home" class="page">
            <h2>Welcome, <span id="userName">User</span>!</h2>
            <h3>Total Balance</h3>
            <h1 id="totalBalance">PKR 0.00</h1>
            
            <div class="status-box">
                <p id="syncStatus">üîÑ Sync Status: Checking...</p>
                <p id="entryCount">üìù Total Entries: 0</p>
                <p id="homeSyncStatus">üîÑ Sync with Cloud: Ready</p>
            </div>
            
            <div class="quick-actions">
                <button onclick="showPage('entry')" class="primary-btn">‚ûï Add New Entry</button>
                <button onclick="showPage('ledger')" class="secondary-btn">üìä View Ledger</button>
                <button onclick="quickSearch()" class="secondary-btn">üîç Quick Search</button>
            </div>
            
            <div class="recent-entries">
                <h3>üìã Recent Transactions (Last 10)</h3>
                <div id="recentEntries">
                    <div class="no-entries">No recent transactions</div>
                </div>
            </div>
        </section>

        <!-- SETTINGS PAGE -->
        <section id="settings" class="page">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="settings-section">
                <h3>1Ô∏è‚É£ Category Management</h3>
                <div class="input-group">
                    <input type="text" id="mainHeadInput" placeholder="Enter Main Category (e.g., Food, Salary)">
                    <button onclick="addMainHead()" class="primary-btn">‚ûï Add Main Category</button>
                </div>
                
                <div class="input-group">
                    <select id="mainForSub"></select>
                    <input type="text" id="subHeadInput" placeholder="Enter Sub Category (e.g., Groceries, Dining)">
                    <button onclick="addSubHead()" class="primary-btn">‚ûï Add Sub Category</button>
                </div>
                
                <div class="categories-list">
                    <h4>üìÅ Current Categories</h4>
                    <ul id="headList"></ul>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>2Ô∏è‚É£ User Information</h3>
                <div id="userInfo">
                    <div class="status-indicator status-connected">
                        <strong>Logged in as:</strong> <span id="settingsUserEmail">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>3Ô∏è‚É£ Cloud Sync Status</h3>
                <div id="cloudSyncStatus">
                    <div class="status-indicator status-disconnected">
                        ‚ùå Cloud Sync: Not configured
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="testAPI()" class="secondary-btn">üß™ Test API Connection</button>
                </div>
            </div>
            
            <div class="settings-section" id="csvSection">
                <h3>4Ô∏è‚É£ CSV Import/Export</h3>
                <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                    Export your data to CSV file or import entries from CSV file.
                </p>
                <div class="button-group" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button onclick="exportToCSV()" class="primary-btn" style="background-color: #4caf50;">
                        üì• Export All to CSV
                    </button>
                    <label style="cursor: pointer; display: inline-block;">
                        <div class="secondary-btn" style="background-color: #2196f3; padding: 12px 20px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; text-align: center;">
                            üì§ Import from CSV
                        </div>
                        <input type="file" id="csvImportInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                    </label>
                </div>
                <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <p style="margin: 0; color: #856404; font-size: 0.85em;">
                        <strong>Note:</strong> CSV import will add new entries. Required columns: Date, Description, Main Category, Sub Category, Amount
                    </p>
                </div>
            </div>
        </section>

        <!-- ENTRY PAGE -->
        <section id="entry" class="page">
            <h2>‚ûï Add / Edit Entries</h2>
            
            <div class="entry-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Main Category:</label>
                        <select id="entryMain" onchange="updateEntrySubheads()">
                            <option value="">-- Select Main Category --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Sub Category:</label>
                        <select id="entrySub">
                            <option value="">-- Select Sub Category --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="date" value="">
                    </div>
                    
                    <div class="form-group">
                        <label>Description:</label>
                        <input type="text" id="desc" placeholder="Enter description">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount:</label>
                        <input type="number" id="amount" placeholder="Enter amount" step="0.01">
                        <small>Use positive for income, negative for expense</small>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="addTemp()" class="primary-btn">üìù Add to Temporary List</button>
                    <button onclick="saveAll()" class="success-btn">üíæ Save All Entries</button>
                    <button onclick="clearTemp()" class="secondary-btn">üóëÔ∏è Clear Temporary</button>
                    <button onclick="cancelEdit()" id="cancelEditBtn" class="secondary-btn" style="display: none;">‚ùå Cancel Edit</button>
                </div>
            </div>
            
            <div class="lists-container">
                <div class="list-section">
                    <h3>üìã Temporary Entries (Pending Save)</h3>
                    <div id="tempList">
                        <div class="no-entries">No temporary entries</div>
                    </div>
                </div>
                
                <div class="list-section">
                    <h3>üíæ Saved Entries (Recent 20)</h3>
                    <div id="savedEntryList">
                        <div class="no-entries">No saved entries</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BALANCE PAGE -->
        <section id="balance" class="page">
            <h2>üí∞ Balance Details</h2>
            
            <div class="summary-cards">
                <div class="card income-card">
                    <h4>Total Income</h4>
                    <p id="totalIncome">PKR 0.00</p>
                </div>
                <div class="card expense-card">
                    <h4>Total Expense</h4>
                    <p id="totalExpense">PKR 0.00</p>
                </div>
                <div class="card balance-card">
                    <h4>Net Balance</h4>
                    <p id="netBalance">PKR 0.00</p>
                </div>
            </div>
            
            <h3>üìä Category-wise Balance</h3>
            <ul id="balanceList" class="category-list"></ul>
        </section>

        <!-- LEDGER PAGE -->
        <section id="ledger" class="page">
            <h2>üìí Ledger View</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label>Main Category:</label>
                    <select id="ledgerMain" onchange="updateLedgerSubheads()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Sub Category:</label>
                    <select id="ledgerSub">
                        <option value="">All Sub-categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Date Range:</label>
                    <input type="date" id="fromDate">
                    <span>to</span>
                    <input type="date" id="toDate">
                </div>
                
                <div class="filter-group">
                    <label>Transaction Type:</label>
                    <select id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="income">Income Only</option>
                        <option value="expense">Expense Only</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Amount Range:</label>
                    <input type="number" id="minAmountFilter" placeholder="Min PKR" step="0.01">
                    <span>to</span>
                    <input type="number" id="maxAmountFilter" placeholder="Max PKR" step="0.01">
                </div>
            </div>
            
            <div class="action-buttons">
                <button onclick="loadLedger()" class="primary-btn">üîç Apply Filters</button>
                <button onclick="resetLedgerFilters()" class="secondary-btn">üîÑ Reset Filters</button>
                <button onclick="exportLedger()" class="success-btn">üì• Export to CSV</button>
            </div>
            
            <div class="ledger-summary">
                <p id="ledgerStats">Showing 0 transactions | Total: PKR 0.00</p>
            </div>
            
            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                <table id="ledgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Main Category</th>
                            <th>Sub Category</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerList">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px;">
                                No transactions found. Add entries from the "Add Entry" page.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- SEARCH PAGE -->
        <section id="search" class="page">
            <h2>üîç Search Transactions</h2>
            
            <div class="search-controls">
                <div class="search-input-group">
                    <input type="text" id="searchInput" placeholder="Search by description...">
                    <div class="search-buttons">
                        <button onclick="performSearch()" class="primary-btn">üîç Search</button>
                        <button onclick="clearSearch()" class="secondary-btn">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>Date Range:</label>
                            <div class="filter-item-row">
                                <input type="date" id="searchFromDate" placeholder="From">
                                <span>to</span>
                                <input type="date" id="searchToDate" placeholder="To">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label>Amount Range:</label>
                            <div class="filter-item-row">
                                <input type="number" id="minAmount" placeholder="Min PKR" step="0.01">
                                <span>to</span>
                                <input type="number" id="maxAmount" placeholder="Max PKR" step="0.01">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label>Type:</label>
                            <select id="searchType">
                                <option value="all">All Types</option>
                                <option value="income">Income Only</option>
                                <option value="expense">Expense Only</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label>Category:</label>
                            <select id="searchCategory">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="results-summary">
                <p id="searchResultsCount">üîç Found 0 transactions</p>
                <p id="searchTotal">üí∞ Total: PKR 0.00</p>
            </div>
            
            <div class="search-results">
                <div id="searchResults">
                    <div class="no-results">üì≠ No transactions found</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Global Debug Panel -->
    <div id="globalDebugPanel" class="debug-panel debug-minimized">
        <div class="debug-header" onclick="toggleDebugPanel()">
            <span class="debug-title">üîß Debug Console</span>
            <div class="debug-controls">
                <button onclick="clearDebugLogs(event)">Clear</button>
                <button onclick="exportDebugLogs(event)">Export</button>
            </div>
        </div>
        <div class="debug-content" id="debugContent"></div>
    </div>

    <!-- Load scripts -->
    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>
    
    <!-- Enhanced debugging and initialization -->
    <script>
        // Global debug functions
        window.debugLog = function(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#c0c0c0',
                success: '#4caf50',
                warning: '#ff9800',
                error: '#f44336'
            };
            
            // Log to browser console
            const logMethods = {
                info: console.log,
                success: console.log,
                warning: console.warn,
                error: console.error
            };
            logMethods[type]?.call(console, `[${timestamp}] ${message}`);
            
            // Add to global debug panel
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const logEntry = document.createElement('div');
                logEntry.className = `debug-log ${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logEntry.style.color = colors[type] || colors.info;
                debugContent.appendChild(logEntry);
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            // Add to auth debug panel if on auth screen
            const authDebug = document.getElementById('authDebugInfo');
            if (authDebug && document.getElementById('authScreen').style.display !== 'none') {
                const authLog = document.createElement('div');
                authLog.textContent = `[${timestamp}] ${message}`;
                authLog.style.color = colors[type] || colors.info;
                authDebug.appendChild(authLog);
                authDebug.scrollTop = authDebug.scrollHeight;
            }
        };
        
        // Debug panel controls
        function toggleDebugPanel() {
            const panel = document.getElementById('globalDebugPanel');
            panel.classList.toggle('debug-minimized');
        }
        
        function clearDebugLogs(e) {
            e.stopPropagation();
            document.getElementById('debugContent').innerHTML = '';
            debugLog('Debug logs cleared', 'info');
        }
        
        function exportDebugLogs(e) {
            e.stopPropagation();
            const logs = Array.from(document.querySelectorAll('.debug-log'))
                .map(log => log.textContent)
                .join('\n');
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug_logs_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            debugLog('Debug logs exported', 'success');
        }
        
        // Auth debug functions
        function testAPIConnection() {
            debugLog('Testing API connection...', 'info');
            
            fetch('/api/health')
                .then(response => {
                    debugLog(`API Status: ${response.status} ${response.statusText}`, 'info');
                    return response.json();
                })
                .then(data => {
                    debugLog(`API Response: ${JSON.stringify(data)}`, 'success');
                })
                .catch(error => {
                    debugLog(`API Error: ${error.message}`, 'error');
                });
        }
        
        function checkLocalStorage() {
            debugLog('Checking localStorage...', 'info');
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('auth_user');
            
            debugLog(`auth_token: ${token ? 'Exists (' + token.substring(0, 20) + '...)' : 'Missing'}`, 'info');
            debugLog(`auth_user: ${user ? 'Exists' : 'Missing'}`, 'info');
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    debugLog(`User email: ${userData.email || 'N/A'}`, 'info');
                    debugLog(`User ID: ${userData.id || 'N/A'}`, 'info');
                } catch (e) {
                    debugLog(`Error parsing user data: ${e.message}`, 'error');
                }
            }
        }
        
        function clearAuthDebug() {
            const authDebug = document.getElementById('authDebugInfo');
            if (authDebug) {
                authDebug.innerHTML = '<div>Logs cleared</div>';
            }
        }
        
        // Force expose functions to window for debugging
        function exposeDebugFunctions() {
            window.debug = {
                log: debugLog,
                testAPI: testAPIConnection,
                checkStorage: checkLocalStorage,
                clearLogs: clearDebugLogs
            };
            
            debugLog('Debug functions exposed to window.debug', 'success');
        }
        
        // Initialize debug
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('=== PAGE LOADED ===', 'success');
            debugLog(`URL: ${window.location.href}`, 'info');
            debugLog(`User Agent: ${navigator.userAgent}`, 'info');
            
            // Check for critical scripts
            const scripts = ['db.js', 'auth.js', 'app.js'];
            scripts.forEach(script => {
                const found = Array.from(document.scripts).some(s => s.src.includes(script));
                debugLog(`${script}: ${found ? '‚úì Loaded' : '‚úó Missing'}`, found ? 'success' : 'error');
            });
            
            // Check if auth functions are available
            setTimeout(() => {
                debugLog('Checking available functions...', 'info');
                debugLog(`login function: ${typeof window.login === 'function' ? '‚úì Available' : '‚úó Missing'}`, 
                        typeof window.login === 'function' ? 'success' : 'error');
                debugLog(`register function: ${typeof window.register === 'function' ? '‚úì Available' : '‚úó Missing'}`, 
                        typeof window.register === 'function' ? 'success' : 'error');
                
                // Setup test button
                const testBtn = document.getElementById('testBtn');
                if (testBtn) {
                    testBtn.addEventListener('click', testAPIConnection);
                    debugLog('Test API button wired up', 'success');
                }
                
                // Add direct click handlers for debugging
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                
                if (loginBtn) {
                    loginBtn.addEventListener('click', function(e) {
                        debugLog('Login button clicked (direct handler)', 'info');
                        debugLog(`Email value: ${document.getElementById('authEmail').value}`, 'info');
                        debugLog(`Password value: ${document.getElementById('authPassword').value ? '***' : 'empty'}`, 'info');
                        
                        // If login function exists, call it
                        if (typeof window.login === 'function') {
                            window.login();
                        } else {
                            debugLog('ERROR: window.login() not found!', 'error');
                            alert('Login function not available. Check console.');
                        }
                    });
                }
                
                if (registerBtn) {
                    registerBtn.addEventListener('click', function(e) {
                        debugLog('Register button clicked (direct handler)', 'info');
                        debugLog(`Email value: ${document.getElementById('authEmail').value}`, 'info');
                        debugLog(`Password value: ${document.getElementById('authPassword').value ? '***' : 'empty'}`, 'info');
                        
                        // If register function exists, call it
                        if (typeof window.register === 'function') {
                            window.register();
                        } else {
                            debugLog('ERROR: window.register() not found!', 'error');
                            alert('Register function not available. Check console.');
                        }
                    });
                }
                
                // Expose debug functions
                exposeDebugFunctions();
                
                // Auto-test API connection
                setTimeout(testAPIConnection, 500);
                
            }, 1000);
        });
        
        // Enhanced Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const authScreen = document.getElementById('authScreen');
                if (authScreen && authScreen.style.display !== 'none') {
                    debugLog('Enter key pressed in auth screen', 'info');
                    
                    const focused = document.activeElement;
                    if (focused && (focused.id === 'authEmail' || focused.id === 'authPassword')) {
                        if (typeof window.login === 'function') {
                            window.login();
                        } else {
                            debugLog('Cannot trigger login: function not available', 'error');
                        }
                    }
                }
            }
        });
        
        // Monitor fetch requests for debugging
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : args[0].url;
            const method = args[1]?.method || 'GET';
            
            debugLog(`Fetch: ${method} ${url}`, 'info');
            
            return originalFetch.apply(this, args)
                .then(response => {
                    debugLog(`Fetch Response: ${response.status} ${response.statusText} for ${url}`, 
                            response.ok ? 'success' : 'warning');
                    return response;
                })
                .catch(error => {
                    debugLog(`Fetch Error: ${error.message} for ${url}`, 'error');
                    throw error;
                });
        };
        
        debugLog('Debug system initialized', 'success');
    </script>
</body>
</html>
