<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts Diary</title>
    
    <!-- SIMPLE FAVICON FIX -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìí</text></svg>">
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- Debug Panel Styles -->
    <style>
        /* VISIBLE DEBUG PANEL STYLES */
        #debugPanel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            border: 2px solid #4CAF50;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        #debugToggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .debug-log {
            margin: 2px 0;
            padding: 2px;
            border-bottom: 1px solid #333;
        }
        
        .debug-success {
            color: #4CAF50;
        }
        
        .debug-error {
            color: #f44336;
        }
        
        .debug-warning {
            color: #ff9800;
        }
        
        .debug-info {
            color: #2196F3;
        }
        
        #debugHeader {
            background: #333;
            padding: 5px;
            margin: -10px -10px 10px -10px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #debugClear {
            background: #666;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <!-- DEBUG TOGGLE BUTTON -->
    <button id="debugToggle" onclick="toggleDebug()">üîç</button>
    
    <!-- VISIBLE DEBUG PANEL -->
    <div id="debugPanel">
        <div id="debugHeader">
            <strong>üìä DEBUG PANEL</strong>
            <button id="debugClear" onclick="clearDebugLogs()">Clear</button>
        </div>
        <div id="debugLogs">
            <div class="debug-log debug-info">Debug panel initialized...</div>
        </div>
    </div>
    
    <!-- ==================== AUTHENTICATION SCREEN ==================== -->
    <div id="authScreen" style="display: block;">
        <div class="auth-container">
            <h1>üí∞ Accounts Diary</h1>
            <div class="auth-box">
                <h3>üîê Login to Continue</h3>
                <div class="input-group">
                    <input type="email" id="authEmail" placeholder="Email" value="jonepeter672@gmail.com">
                </div>
                <div class="input-group">
                    <input type="password" id="authPassword" placeholder="Password" value="test123">
                </div>
                <div class="auth-buttons">
                    <button onclick="login()" class="primary-btn">Login</button>
                    <button onclick="register()" class="secondary-btn">Register</button>
                </div>
                <p id="authError" style="color: red; margin-top: 10px;"></p>
                <p id="authStatus" style="color: green; margin-top: 10px;"></p>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP SCREEN ==================== -->
    <div id="appScreen" style="display: none;">
        <!-- Navigation -->
        <nav>
            <button onclick="showPage('home')">üè† Home</button>
            <button onclick="showPage('entry')">‚ûï Add Entry</button>
            <button onclick="showPage('balance')">üí∞ Balance</button>
            <button onclick="showPage('ledger')">üìí Ledger</button>
            <button onclick="showPage('search')">üîç Search</button>
            <button onclick="showPage('settings')">‚öôÔ∏è Settings</button>
            <button onclick="logout()" class="danger-btn">üö™ Logout</button>
        </nav>

        <!-- HOME PAGE -->
        <section id="home" class="page" style="display: none;">
            <h2>Welcome, <span id="userName">User</span>!</h2>
            <h3>Total Balance</h3>
            <h1 id="totalBalance">PKR 0.00</h1>
            
            <div class="status-box">
                <p id="syncStatus">üîÑ Sync Status: Checking...</p>
                <p id="entryCount">üìù Total Entries: 0</p>
                <p id="homeSyncStatus">üîÑ Sync with Cloud: Ready</p>
            </div>
            
            <div class="quick-actions">
                <button onclick="showPage('entry')" class="primary-btn">‚ûï Add New Entry</button>
                <button onclick="showPage('ledger')" class="secondary-btn">üìä View Ledger</button>
                <button onclick="quickSearch()" class="secondary-btn">üîç Quick Search</button>
                <button onclick="syncWithCloud()" class="primary-btn sync-to-btn">‚¨ÜÔ∏è Sync TO Cloud</button>
                <button onclick="syncFromCloud()" class="primary-btn sync-from-btn">‚¨áÔ∏è Sync FROM Cloud</button>
            </div>
            
            <div class="recent-entries">
                <h3>üìã Recent Transactions (Last 10)</h3>
                <div id="recentEntries">
                    <div class="no-entries">No recent transactions</div>
                </div>
            </div>
        </section>

        <!-- SETTINGS PAGE -->
        <section id="settings" class="page" style="display: none;">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="settings-section">
                <h3>1Ô∏è‚É£ Category Management</h3>
                <div class="input-group">
                    <input type="text" id="mainHeadInput" placeholder="Enter Main Category (e.g., Food, Salary)">
                    <button onclick="addMainHead()" class="primary-btn">‚ûï Add Main Category</button>
                </div>
                
                <div class="input-group">
                    <select id="mainForSub"></select>
                    <input type="text" id="subHeadInput" placeholder="Enter Sub Category (e.g., Groceries, Dining)">
                    <button onclick="addSubHead()" class="primary-btn">‚ûï Add Sub Category</button>
                </div>
                
                <div class="categories-list">
                    <h4>üìÅ Current Categories</h4>
                    <ul id="headList"></ul>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>2Ô∏è‚É£ User Information</h3>
                <div id="userInfo">
                    <div class="status-indicator status-connected">
                        <strong>Logged in as:</strong> <span id="settingsUserEmail">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>3Ô∏è‚É£ Cloud Sync Status</h3>
                <div id="cloudSyncStatus">
                    <div class="status-indicator status-disconnected">
                        ‚ùå Cloud Sync: Not configured
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="testAPI()" class="secondary-btn">üß™ Test API Connection</button>
                </div>
            </div>
            
            <!-- CSV Import/Export Section -->
            <div class="settings-section" id="csvSection">
                <h3>4Ô∏è‚É£ CSV Import/Export</h3>
                <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                    Export your data to CSV file or import entries from CSV file.
                </p>
                <div class="button-group" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button onclick="exportToCSV()" class="primary-btn" style="background-color: #4caf50;">
                        üì• Export All to CSV
                    </button>
                    <label style="cursor: pointer; display: inline-block;">
                        <div class="secondary-btn" style="background-color: #2196f3; padding: 12px 20px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; text-align: center;">
                            üì§ Import from CSV
                        </div>
                        <input type="file" id="csvImportInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                    </label>
                </div>
                <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <p style="margin: 0; color: #856404; font-size: 0.85em;">
                        <strong>Note:</strong> CSV import will add new entries. Existing entries with same ID will be updated.
                        Required columns: Date, Description, Main Category, Sub Category, Amount
                    </p>
                </div>
            </div>
        </section>

        <!-- ENTRY PAGE -->
        <section id="entry" class="page" style="display: none;">
            <h2>‚ûï Add / Edit Entries</h2>
            
            <div class="entry-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Main Category:</label>
                        <select id="entryMain" onchange="updateEntrySubheads()">
                            <option value="">-- Select Main Category --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Sub Category:</label>
                        <select id="entrySub">
                            <option value="">-- Select Sub Category --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="date" value="">
                    </div>
                    
                    <div class="form-group">
                        <label>Description:</label>
                        <input type="text" id="desc" placeholder="Enter description">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount:</label>
                        <input type="number" id="amount" placeholder="Enter amount" step="0.01">
                        <small>Use positive for income, negative for expense</small>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="addTemp()" class="primary-btn">üìù Add to Temporary List</button>
                    <button onclick="saveAll()" class="success-btn">üíæ Save All Entries</button>
                    <button onclick="clearTemp()" class="secondary-btn">üóëÔ∏è Clear Temporary</button>
                    <button onclick="cancelEdit()" id="cancelEditBtn" class="secondary-btn" style="display: none;">‚ùå Cancel Edit</button>
                </div>
            </div>
            
            <div class="lists-container">
                <div class="list-section">
                    <h3>üìã Temporary Entries (Pending Save)</h3>
                    <div id="tempList">
                        <div class="no-entries">No temporary entries</div>
                    </div>
                </div>
                
                <div class="list-section">
                    <h3>üíæ Saved Entries (Recent 20)</h3>
                    <div id="savedEntryList">
                        <div class="no-entries">No saved entries</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BALANCE PAGE -->
        <section id="balance" class="page" style="display: none;">
            <h2>üí∞ Balance Details</h2>
            
            <div class="summary-cards">
                <div class="card income-card">
                    <h4>Total Income</h4>
                    <p id="totalIncome">PKR 0.00</p>
                </div>
                <div class="card expense-card">
                    <h4>Total Expense</h4>
                    <p id="totalExpense">PKR 0.00</p>
                </div>
                <div class="card balance-card">
                    <h4>Net Balance</h4>
                    <p id="netBalance">PKR 0.00</p>
                </div>
            </div>
            
            <h3>üìä Category-wise Balance</h3>
            <ul id="balanceList" class="category-list"></ul>
        </section>

        <!-- LEDGER PAGE -->
        <section id="ledger" class="page" style="display: none;">
            <h2>üìí Ledger View</h2>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label>Main Category:</label>
                    <select id="ledgerMain" onchange="updateLedgerSubheads()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Sub Category:</label>
                    <select id="ledgerSub">
                        <option value="">All Sub-categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Date Range:</label>
                    <input type="date" id="fromDate">
                    <span>to</span>
                    <input type="date" id="toDate">
                </div>
                
                <div class="filter-group">
                    <label>Transaction Type:</label>
                    <select id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="income">Income Only</option>
                        <option value="expense">Expense Only</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Amount Range:</label>
                    <input type="number" id="minAmountFilter" placeholder="Min PKR" step="0.01">
                    <span>to</span>
                    <input type="number" id="maxAmountFilter" placeholder="Max PKR" step="0.01">
                </div>
            </div>
            
            <div class="action-buttons">
                <button onclick="loadLedger()" class="primary-btn">üîç Apply Filters</button>
                <button onclick="resetLedgerFilters()" class="secondary-btn">üîÑ Reset Filters</button>
                <button onclick="exportLedger()" class="success-btn">üì• Export to CSV</button>
            </div>
            
            <div class="ledger-summary">
                <p id="ledgerStats">Showing 0 transactions | Total: PKR 0.00</p>
            </div>
            
            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                <table id="ledgerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Main Category</th>
                            <th>Sub Category</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerList">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px;">
                                No transactions found. Add entries from the "Add Entry" page.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- SEARCH PAGE -->
        <section id="search" class="page" style="display: none;">
            <h2>üîç Search Transactions</h2>
            
            <div class="search-controls">
                <div class="search-input-group">
                    <input type="text" id="searchInput" placeholder="Search by description...">
                    <div class="search-buttons">
                        <button onclick="performSearch()" class="primary-btn">üîç Search</button>
                        <button onclick="clearSearch()" class="secondary-btn">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>Date Range:</label>
                            <div class="filter-item-row">
                                <input type="date" id="searchFromDate" placeholder="From">
                                <span>to</span>
                                <input type="date" id="searchToDate" placeholder="To">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label>Amount Range:</label>
                            <div class="filter-item-row">
                                <input type="number" id="minAmount" placeholder="Min PKR" step="0.01">
                                <span>to</span>
                                <input type="number" id="maxAmount" placeholder="Max PKR" step="0.01">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label>Type:</label>
                            <select id="searchType">
                                <option value="all">All Types</option>
                                <option value="income">Income Only</option>
                                <option value="expense">Expense Only</option>
                            </select>
                        </div>
                        
                        <div class="filter-item">
                            <label>Category:</label>
                            <select id="searchCategory">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="results-summary">
                <p id="searchResultsCount">üîç Found 0 transactions</p>
                <p id="searchTotal">üí∞ Total: PKR 0.00</p>
            </div>
            
            <div class="search-results">
                <div id="searchResults">
                    <div class="no-results">üì≠ No transactions found</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Load the REAL JavaScript files -->
    <script src="./db.js?v=20240204_0800"></script>
    <script src="./app.js?v=20240204_0800"></script>
    
    <!-- Debug script to check function availability -->
    <script>
        // Check if functions are properly exposed
        function verifyFunctions() {
            console.log("=== VERIFYING FUNCTIONS ===");
            
            const requiredFunctions = [
                'login', 'register', 'logout', 'checkAuth',
                'showPage', 'addTemp', 'saveAll', 'addMainHead'
            ];
            
            let allGood = true;
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`‚úÖ ${funcName}() is available`);
                } else {
                    console.log(`‚ùå ${funcName}() is NOT available`);
                    allGood = false;
                }
            });
            
            // Also check dbAPI
            console.log("=== CHECKING DB API ===");
            if (window.dbAPI) {
                console.log("‚úÖ dbAPI is available");
                console.log("dbAPI methods:", Object.keys(window.dbAPI));
            } else {
                console.log("‚ùå dbAPI is NOT available");
                allGood = false;
            }
            
            return allGood;
        }
        
        // Check immediately and periodically
        setTimeout(() => {
            console.log("=== INITIAL CHECK (after 500ms) ===");
            verifyFunctions();
        }, 500);
        
        setTimeout(() => {
            console.log("=== SECOND CHECK (after 2000ms) ===");
            verifyFunctions();
        }, 2000);
        
        // Add a global error handler
        window.addEventListener('error', function(event) {
            console.error("Global error caught:", event.message);
            console.error("File:", event.filename);
            console.error("Line:", event.lineno);
            
            // Show in debug panel
            if (window.addDebugLog) {
                addDebugLog(`ERROR: ${event.message}`, 'error');
            }
        });
    </script>
    
    <!-- Simple initialization -->
    <script>
        // Pre-fill demo credentials for testing (optional)
        window.onload = function() {
            const authEmail = document.getElementById('authEmail');
            const authPassword = document.getElementById('authPassword');
            
            if (authEmail && authPassword) {
                authEmail.value = 'jonepeter672@gmail.com';
                authPassword.value = 'test123';
            }
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            const dateField = document.getElementById('date');
            if (dateField) {
                dateField.value = today;
            }
            
            // Auto-show debug panel if there are errors
            setTimeout(() => {
                if (typeof login !== 'function') {
                    console.error("login() function still not loaded!");
                    if (window.addDebugLog) {
                        addDebugLog('ERROR: login() function not loaded!', 'error');
                    }
                    document.getElementById('debugPanel').style.display = 'block';
                } else {
                    console.log("‚úÖ login() function is now available");
                    // Auto-check auth
                    checkAuth();
                }
            }, 1000);
        };
    </script>

    <!-- VISIBLE DEBUG SYSTEM -->
    <script>
        // VISIBLE DEBUG SYSTEM FOR MOBILE
        let debugEnabled = true;
        let debugLogs = [];
        
        // Add log to visible panel
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            debugLogs.push(logEntry);
            
            // Update visible panel
            const debugLogsDiv = document.getElementById('debugLogs');
            if (debugLogsDiv) {
                const logDiv = document.createElement('div');
                logDiv.className = `debug-log debug-${type}`;
                logDiv.innerHTML = `<span style="color: #888">[${timestamp}]</span> ${message}`;
                debugLogsDiv.appendChild(logDiv);
                
                // Auto-scroll to bottom
                debugLogsDiv.scrollTop = debugLogsDiv.scrollHeight;
            }
            
            // Also log to console if available
            if (typeof console !== 'undefined') {
                const consoleMethod = type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log';
                console[consoleMethod](`[${timestamp}] ${message}`);
            }
        }
        
        // Toggle debug panel visibility
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel.style.display === 'block') {
                debugPanel.style.display = 'none';
                addDebugLog('Debug panel hidden', 'info');
            } else {
                debugPanel.style.display = 'block';
                addDebugLog('Debug panel shown', 'info');
            }
        }
        
        // Clear debug logs
        function clearDebugLogs() {
            debugLogs = [];
            const debugLogsDiv = document.getElementById('debugLogs');
            if (debugLogsDiv) {
                debugLogsDiv.innerHTML = '<div class="debug-log debug-info">Logs cleared</div>';
            }
            addDebugLog('Debug logs cleared', 'info');
        }
        
        // Check if a file exists
        function checkFileExists(url) {
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', url);
                xhr.onload = function() {
                    resolve(xhr.status === 200);
                };
                xhr.onerror = function() {
                    resolve(false);
                };
                xhr.send();
            });
        }
        
        // Check all required resources
        async function checkAllResources() {
            addDebugLog('Checking required files...', 'info');
            
            const filesToCheck = [
                { name: 'style.css', url: 'style.css', required: true },
                { name: 'db.js', url: 'db.js', required: true },
                { name: 'app.js', url: 'app.js', required: true },
                { name: 'manifest.json', url: 'manifest.json', required: false }
            ];
            
            for (const file of filesToCheck) {
                try {
                    const exists = await checkFileExists(file.url);
                    if (exists) {
                        addDebugLog(`‚úÖ ${file.name} found`, 'success');
                    } else {
                        if (file.required) {
                            addDebugLog(`‚ùå ${file.name} NOT FOUND (required)`, 'error');
                        } else {
                            addDebugLog(`‚ö†Ô∏è ${file.name} not found (optional)`, 'warning');
                        }
                    }
                } catch (error) {
                    addDebugLog(`‚ùå Error checking ${file.name}: ${error.message}`, 'error');
                }
            }
            
            // Check page elements
            addDebugLog('Checking page structure...', 'info');
            
            const elements = [
                { id: 'authScreen', name: 'Auth Screen' },
                { id: 'appScreen', name: 'App Screen' },
                { id: 'authEmail', name: 'Email Input' },
                { id: 'authPassword', name: 'Password Input' }
            ];
            
            elements.forEach(element => {
                const el = document.getElementById(element.id);
                if (el) {
                    addDebugLog(`‚úÖ ${element.name} found`, 'success');
                } else {
                    addDebugLog(`‚ùå ${element.name} NOT FOUND`, 'error');
                }
            });
            
            // Check if functions are available
            addDebugLog('Checking functions...', 'info');
            
            const functions = ['login', 'showPage', 'logout', 'checkAuth'];
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    addDebugLog(`‚úÖ ${funcName}() function exists`, 'success');
                } else {
                    addDebugLog(`‚ùå ${funcName}() function NOT FOUND`, 'error');
                }
            });
            
            addDebugLog('Resource check complete!', 'info');
        }
        
        // Monitor for errors
        window.addEventListener('error', function(event) {
            addDebugLog(`JavaScript Error: ${event.message}`, 'error');
            addDebugLog(`At: ${event.filename}:${event.lineno}`, 'error');
            return false;
        });
        
        // Initialize debug system
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('Page loaded', 'success');
            addDebugLog('Accounts Diary v1.0', 'info');
            
            // Check resources after a delay
            setTimeout(() => {
                checkAllResources();
            }, 1000);
        });
        
        // Add initial logs
        addDebugLog('Debug system initialized', 'success');
        addDebugLog('Tap üîç button to show/hide debug', 'info');
    </script>
</body>
</html>
